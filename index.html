<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Transliterador</title>

<style>
  body {
    background:#0e0e0e;
    color:#eee;
    font-family: monospace;
    padding:20px;
  }
  textarea {
    width:100%;
    height:220px;
    background:#000;
    color:#0f0;
    border:1px solid #444;
    padding:10px;
    font-size:16px;
  }
  #list {
  margin-top: 15px;
  padding: 10px;
  border: 1px solid #333;
  min-height: 60px;
}

#list li {
  padding: 4px 6px;
  border-bottom: 1px dashed #333;
}
</style>
</head>

<body>

<h2>üßæ Transliterador</h2>
<p>
Y / ' / '' y la secuencia <b>–¢√ß</b> usan <b>TAB</b><br>
vocal&lt; = acento (respeta may√∫sculas)
</p>

<textarea id="txt" placeholder="Escribe aqu√≠..."></textarea>

<hr>

<h2>üìò Diccionario Shalkio</h2>

<div id="letters"></div>

<h3 id="currentLetter">Letra: A</h3>

<input id="word" placeholder="Palabra">
<input id="meaning" placeholder="Significado">
<textarea id="notes" placeholder="Notas (opcional)"></textarea>

<button id="add">‚ûï Agregar palabra</button>
<button id="exportTxt">üíæ Exportar TXT</button>
<button id="exportJson">üíæ Exportar JSON</button>
<input type="file" id="importFile" accept=".txt,.json">

<input id="search" placeholder="üîç Buscar en el diccionario">
<ul id="list"></ul>

<script>
const searchInput = document.getElementById("search");
const txt = document.getElementById("txt");

/* ================= TRANSLITERACI√ìN ================= */

const dict = {
  // MAY√öSCULAS
  "Ch":"–ß","–óh":"–ñ","–öh":"–•'","√ách":"–©",
  "G'":"“ê","Ye":"–ï","Yo":"–Å","√áh":"–®",
  "Ya":"–Ø","Yu":"–Æ","Y'":"–´",

  "A":"–ê","B":"–ë","V":"–í","G":"–ì","D":"–î",
  "K":"–ö","T":"–¢","J":"–•","F":"–§","L":"–õ",
  "M":"–ú","N":"–ù","O":"–û","P":"–ü","R":"–†",
  
  "S":"√á","U":"–£","Z":"–ó","I":"–ò","E":"–≠",
  // MIN√öSCULAS
  "ch":"—á","–∑h":"–∂","–∫h":"—Ö'","√ßch":"—â",
  "g'":"“ë","ye":"–µ","yo":"—ë","ts":"—Å",
  "ya":"—è","yu":"—é","y'":"—ã","√ßh":"—à",

  "a":"–∞","b":"–±","v":"–≤","g":"–≥","d":"–¥",
  "k":"–∫","t":"—Ç","j":"—Ö","f":"—Ñ","l":"–ª",
  "m":"–º","n":"–Ω","o":"–æ","p":"–ø","r":"—Ä",
  "s":"√ß","u":"—É","z":"–∑","i":"–∏","e":"—ç"
};

const keys = Object.keys(dict).sort((a,b)=>b.length-a.length);

/* ================= ACENTOS REALES ================= */

const ACCENT = "\u0301";

const acentos = {
  "–∞":"–∞ÃÅ","—ç":"—çÃÅ","–∏":"–∏ÃÅ","–æ":"–æÃÅ","—É":"—ÉÃÅ","—è":"—èÃÅ","–µ":"–µÃÅ","—é":"—éÃÅ","—ã":"—ãÃÅ",
  "–ê":"√Å","–≠":"–≠¬¥","–ò":"–ò¬¥","–û":"–û¬¥","–£":"–£¬¥","–Ø":"–Ø¬¥","–ï":"–ï¬¥","–Æ":"–Æ¬¥","–´":"–´¬¥"
};

/* ================= INPUT ================= */

txt.addEventListener("input", () => {
  let v = txt.value;

  // 1Ô∏è‚É£ transliterar
  for (const k of keys) {
    v = v.replaceAll(k, dict[k]);
  }

  // 2Ô∏è‚É£ acentos con <
  v = v.replace(/([–ê–≠–ò–û–£–Ø–ï–Æ–´–∞–µ–∏–æ—É—è—é—ã—ç])</g, (m, l) =>
    acentos[l] ?? l
  );

  txt.value = v;
});

/* ================= TAB ESPECIAL ================= */

txt.addEventListener("keydown", (e) => {
  if (e.key !== "Tab") return;

  e.preventDefault();
  let pos = txt.selectionStart;
  let text = txt.value;

  if (text.slice(pos-2, pos) === "–ì") {
    txt.value = text.slice(0,pos-2) + "“ê" + text.slice(pos);
    txt.selectionStart = txt.selectionEnd = pos;
    return;
  }
  
  if (text.slice(pos-2, pos) === "–≥") {
    txt.value = text.slice(0,pos-2) + "“ë" + text.slice(pos);
    txt.selectionStart = txt.selectionEnd = pos;
    return;
  }
  
  if (text.slice(pos-2, pos) === "–¢√ß") {
    txt.value = text.slice(0,pos-2) + "–°" + text.slice(pos);
    txt.selectionStart = txt.selectionEnd = pos-1;
    return;
  }

  if (text.slice(pos-2, pos) === "—Ç√ß") {
    txt.value = text.slice(0,pos-2) + "—Å" + text.slice(pos);
    txt.selectionStart = txt.selectionEnd = pos-1;
    return;
  }

  if (text.slice(pos-2, pos) === "''") {
    txt.value = text.slice(0,pos-2) + "—ä" + text.slice(pos);
    txt.selectionStart = txt.selectionEnd = pos-1;
    return;
  }

  if (text[pos-1] === "'") {
    txt.value = text.slice(0,pos-1) + "—å" + text.slice(pos);
    txt.selectionStart = txt.selectionEnd = pos;
    return;
  }

  if (text[pos-1] === "Y") {
    txt.value = text.slice(0,pos-1) + "–ô" + text.slice(pos);
    txt.selectionStart = txt.selectionEnd = pos;
    return;
  }

  if (text[pos-1] === "y") {
    txt.value = text.slice(0,pos-1) + "–π" + text.slice(pos);
    txt.selectionStart = txt.selectionEnd = pos;
    return;
  }
});
/* ================= DICCIONARIO ================= */

const alphabet = [
  "–ê","–ë","–í","–ì","“ê","–ï","–Å","–°","–î","–ö","–•'","–•","–§","–õ","–ú","–ù",
  "–û","–ü","–†","–°'","–¢","–£","–ó","–ñ","–ò","–ô","–´","–Ø","–Æ",
  "–ß","–®","–©","–≠"
];
const lettersDiv = document.getElementById("letters");
const list = document.getElementById("list");

const wordInput = document.getElementById("word");
const meaningInput = document.getElementById("meaning");
const notesInput = document.getElementById("notes");

let dictionary = JSON.parse(localStorage.getItem("shalkioDict")) || {};

// üßπ eliminar claves que NO est√©n en el alfabeto del idioma
for (const key in dictionary) {
  if (!alphabet.includes(key)) {
    delete dictionary[key];
  }
}
localStorage.setItem("shalkioDict", JSON.stringify(dictionary));

// inicializaci√≥n segura
alphabet.forEach(l => {
  if (!Array.isArray(dictionary[l])) dictionary[l] = [];
});

let current = alphabet[0];

// botones de letras
alphabet.forEach(l => {
  const b = document.createElement("button");
  b.textContent = l;
  b.onclick = () => loadLetter(l);
  lettersDiv.appendChild(b);
});

function loadLetter(l) {
  current = l;
  document.getElementById("currentLetter").textContent = "Letra: " + l;
  render();
}

function render() {
  list.innerHTML = "";

  const query = searchInput.value.toLowerCase();
  let entries = dictionary[current] || [];

  // ordenar siempre
  entries.sort((a, b) => a.word.localeCompare(b.word, "ru"));

  // filtrar por b√∫squeda
  if (query) {
    entries = entries.filter(e =>
      e.word.toLowerCase().includes(query) ||
      e.meaning.toLowerCase().includes(query) ||
      (e.notes && e.notes.toLowerCase().includes(query))
    );
  }

  if (entries.length === 0) {
    const li = document.createElement("li");
    li.style.opacity = "0.5";
    li.textContent = query
      ? "‚Äî sin coincidencias ‚Äî"
      : "‚Äî sin palabras a√∫n ‚Äî";
    list.appendChild(li);
    return;
  }

  entries.forEach(e => {
    const realIndex = dictionary[current].indexOf(e);

    const li = document.createElement("li");

    const content = document.createElement("span");
    content.innerHTML =
      `<b>${e.word}</b> ‚Äî ${e.meaning}` +
      (e.notes ? ` <i>(${e.notes})</i>` : "");

    const editBtn = document.createElement("button");
    editBtn.textContent = "‚úèÔ∏è";
    editBtn.style.marginLeft = "8px";
    editBtn.onclick = () => editEntry(realIndex);

    const delBtn = document.createElement("button");
    delBtn.textContent = "üóëÔ∏è";
    delBtn.style.marginLeft = "4px";
    delBtn.onclick = () => {
      if (!confirm("¬øEliminar esta palabra?")) return;
      dictionary[current].splice(realIndex, 1);
      render();
    };

    li.append(content, editBtn, delBtn);
    list.appendChild(li);
  });

  localStorage.setItem("shalkioDict", JSON.stringify(dictionary));
}


function editEntry(index) {
  const entry = dictionary[current][index];
  list.innerHTML = "";

  dictionary[current].forEach((e, i) => {
    const li = document.createElement("li");

    if (i === index) {
      const w = document.createElement("input");
      w.value = e.word;

      const m = document.createElement("input");
      m.value = e.meaning;

      const n = document.createElement("input");
      n.value = e.notes || "";

      const save = document.createElement("button");
      save.textContent = "üíæ";

      const cancel = document.createElement("button");
      cancel.textContent = "‚ùå";

      save.onclick = () => {
        if (!w.value.trim() || !m.value.trim()) return;
        entry.word = w.value.trim();
        entry.meaning = m.value.trim();
        entry.notes = n.value.trim();
        render();
      };

      cancel.onclick = render;

      li.append(w, m, n, save, cancel);
    } else {
      li.innerHTML = `<b>${e.word}</b> ‚Äî ${e.meaning}` +
        (e.notes ? ` <i>(${e.notes})</i>` : "");
    }

    list.appendChild(li);
  });
}

document.getElementById("add").onclick = () => {
  const word = wordInput.value.trim();
  const meaning = meaningInput.value.trim();
  const notes = notesInput.value.trim();
  if (!word || !meaning) return;

  dictionary[current].push({ word, meaning, notes });
  wordInput.value = meaningInput.value = notesInput.value = "";
  render();
};

// cargar inicial
loadLetter(alphabet[0]);

document.getElementById("exportTxt").onclick = () => {
  let out = "Diccionario Shalkio\n\n";

  for (const l of alphabet) {
    if (!dictionary[l].length) continue;
    out += `# ${l}\n`;
    dictionary[l].forEach(e => {
      out += `${e.word} = ${e.meaning}`;
      if (e.notes) out += ` (${e.notes})`;
      out += "\n";
    });
    out += "\n";
  }

  downloadFile(out, "Diccionario_Shalkio.txt", "text/plain");
};

document.getElementById("exportJson").onclick = () => {
  const data = JSON.stringify(dictionary, null, 2);
  downloadFile(data, "Diccionario_Shalkio.json", "application/json");
};

document.getElementById("importFile").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    if (file.name.endsWith(".json")) {
      importJSON(reader.result);
    } else {
      importTXT(reader.result);
    }
    render();
  };
  reader.readAsText(file, "UTF-8");
});

function importJSON(text) {
  try {
    const data = JSON.parse(text);
    for (const l of alphabet) {
      if (Array.isArray(data[l])) {
        dictionary[l].push(...data[l]);
      }
    }
    localStorage.setItem("shalkioDict", JSON.stringify(dictionary));
  } catch {
    alert("JSON inv√°lido");
  }
}

function importTXT(text) {
  let currentLetter = null;
  const lines = text.split(/\r?\n/);

  lines.forEach(line => {
    line = line.trim();
    if (!line) return;

    if (line.startsWith("#")) {
      const l = line.replace("#","").trim();
      if (alphabet.includes(l)) currentLetter = l;
      return;
    }

    if (!currentLetter) return;

    const match = line.match(/^(.+?)\s*=\s*(.+?)(?:\s*\((.+)\))?$/);
    if (!match) return;

    const [, word, meaning, notes] = match;
    dictionary[currentLetter].push({
      word: word.trim(),
      meaning: meaning.trim(),
      notes: notes?.trim() || ""
    });
  });

  localStorage.setItem("shalkioDict", JSON.stringify(dictionary));
}

function downloadFile(content, name, type) {
  const blob = new Blob([content], { type });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
}
searchInput.addEventListener("input", render);
</script>

</body>
</html>
